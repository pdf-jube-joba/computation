<script>
  // Contextual sidebar loader (navigation.json).
  (function contextualSidebar() {
    const sidebar = document.querySelector('#mdbook-sidebar .sidebar-scrollbox');
    if (!sidebar) {
      return;
    }

    const navUrl = new URL('navigation.json', window.location.href);
    console.log('[nav] navigation.json url', navUrl.href);

    function normalizeItems(data) {
      if (Array.isArray(data)) {
        return data;
      }
      if (data && Array.isArray(data.items)) {
        return data.items;
      }
      return null;
    }

    function buildList(items, isRoot) {
      const list = document.createElement('ol');
      list.className = isRoot ? 'chapter' : 'section';

      items.forEach(item => {
        if (!item || typeof item !== 'object') {
          return;
        }

        if (item.type === 'part' || item.part === true) {
          const part = document.createElement('li');
          part.className = 'part-title';
          part.textContent = item.title || item.text || '';
          list.appendChild(part);
          return;
        }

        const li = document.createElement('li');
        li.className = 'chapter-item expanded';

        const wrapper = document.createElement('span');
        wrapper.className = 'chapter-link-wrapper';
        const title = item.title || item.text || '';
        const href = item.href || item.link || item.url;
        if (href) {
          const link = document.createElement('a');
          link.setAttribute('href', href);
          link.textContent = title;
          wrapper.appendChild(link);
        } else {
          const span = document.createElement('span');
          span.textContent = title;
          wrapper.appendChild(span);
        }
        li.appendChild(wrapper);

        if (Array.isArray(item.children) && item.children.length > 0) {
          li.appendChild(buildList(item.children, false));
        }
        list.appendChild(li);
      });

      return list;
    }

    function markActive(container) {
      const current = window.location.href.toString().split('#')[0].split('?')[0];
      const links = Array.from(container.querySelectorAll('a'));
      links.forEach(link => {
        const href = link.getAttribute('href');
        if (!href || href.startsWith('#') || /^(?:[a-z+]+:)?\/\//.test(href)) {
          return;
        }
        const resolved = new URL(href, window.location.href).href;
        link.href = resolved;
        if (resolved === current) {
          link.classList.add('active');
          let parent = link.parentElement;
          while (parent) {
            if (parent.tagName === 'LI' && parent.classList.contains('chapter-item')) {
              parent.classList.add('expanded');
            }
            parent = parent.parentElement;
          }
        }
      });
    }

    function collectNavItems(items, acc) {
      items.forEach(item => {
        if (!item || typeof item !== 'object') {
          return;
        }
        if (item.type === 'part' || item.part === true) {
          if (Array.isArray(item.children)) {
            collectNavItems(item.children, acc);
          }
          return;
        }

        const href = item.href || item.link || item.url;
        const title = item.title || item.text || '';
        if (href) {
          acc.push({ href, title });
        }
        if (Array.isArray(item.children) && item.children.length > 0) {
          collectNavItems(item.children, acc);
        }
      });
    }

    function updateNavLink(link, target, label) {
      if (!link) {
        console.log(`[nav] ${label} link not found`);
        return;
      }
      if (!target) {
        link.hidden = true;
        link.classList.add('hidden');
        link.setAttribute('aria-disabled', 'true');
        return;
      }
      const resolved = new URL(target.href, window.location.href).href;
      link.hidden = false;
      link.classList.remove('hidden');
      link.setAttribute('aria-disabled', 'false');
      link.setAttribute('href', resolved);
      if (target.title) {
        link.setAttribute('title', target.title);
        link.setAttribute('aria-label', target.title);
      }
    }

    function updatePrevNext(items) {
      const flat = [];
      collectNavItems(items, flat);
      const current = window.location.href.toString().split('#')[0].split('?')[0];
      const index = flat.findIndex(item => {
        const resolved = new URL(item.href, window.location.href).href;
        return resolved === current;
      });
      if (index === -1) {
        console.log('[nav] current page not found in navigation.json');
        return;
      }
      const prev = index > 0 ? flat[index - 1] : null;
      const next = index + 1 < flat.length ? flat[index + 1] : null;

      updateNavLink(document.querySelector('a.mobile-nav-chapters.previous'), prev, 'mobile previous');
      updateNavLink(document.querySelector('a.mobile-nav-chapters.next'), next, 'mobile next');
      updateNavLink(document.querySelector('a.nav-chapters.previous'), prev, 'wide previous');
      updateNavLink(document.querySelector('a.nav-chapters.next'), next, 'wide next');
    }

    function hidePrevNext() {
      updateNavLink(document.querySelector('a.mobile-nav-chapters.previous'), null, 'mobile previous');
      updateNavLink(document.querySelector('a.mobile-nav-chapters.next'), null, 'mobile next');
      updateNavLink(document.querySelector('a.nav-chapters.previous'), null, 'wide previous');
      updateNavLink(document.querySelector('a.nav-chapters.next'), null, 'wide next');
    }

    function shouldIgnoreKeyTarget(target) {
      if (!(target instanceof Element)) {
        return false;
      }
      return !!target.closest('input, textarea, select, [contenteditable="true"]');
    }

    function disableArrowNavigation() {
      const blockedKeys = new Set(['ArrowLeft', 'ArrowRight']);
      document.addEventListener(
        'keydown',
        event => {
          if (!blockedKeys.has(event.key)) {
            return;
          }
          if (shouldIgnoreKeyTarget(event.target)) {
            return;
          }
          event.preventDefault();
          event.stopPropagation();
        },
        true,
      );
    }

    function showSidebar() {
      document.documentElement.classList.add('nav-ready');
    }

    fetch(navUrl, { cache: 'no-store' })
      .then(response => {
        if (!response.ok) {
          console.log('[nav] navigation.json missing', response.status);
          showSidebar();
          return null;
        }
        return response.json();
      })
      .then(data => {
        if (!data) {
          showSidebar();
          return;
        }
        console.log('[nav] navigation.json loaded', data);
        const navEnabled = !(data && data.prev_next === false);
        const items = normalizeItems(data);
        if (!items) {
          console.log('[nav] navigation.json invalid format');
          showSidebar();
          return;
        }
        const list = buildList(items, true);
        sidebar.innerHTML = '';
        sidebar.appendChild(list);
        markActive(sidebar);
        if (navEnabled) {
          updatePrevNext(items);
        } else {
          hidePrevNext();
          disableArrowNavigation();
        }
        showSidebar();
      })
      .catch(error => {
        console.log('[nav] navigation.json error', error);
        showSidebar();
      });
  })();

  (function disableArrowNavWhileTyping() {
    const blockedKeys = new Set(["ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown"]);
    document.addEventListener(
      "keydown",
      event => {
        if (!(event.target instanceof HTMLTextAreaElement)) return;
        if (!blockedKeys.has(event.key)) return;
        event.stopPropagation();
      },
      true,
    );
  })();

</script>
